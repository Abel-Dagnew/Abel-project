# azure-pipelines.yml

# Trigger the pipeline on changes to the main branch
trigger:
  branches:
    include:
      - main  # Adjust this to your branch

# Use the latest Ubuntu VM image
pool:
  vmImage: 'ubuntu-latest'

# Define build and deployment stages
stages:
  

  - stage: BuildDockerImage
    displayName: 'Build Docker Image'
    jobs:
      - job: BuildDocker
        displayName: 'Build Docker Image'
        steps:
          - script: |
              docker build -t $ACR_NAME/$DOCKER_IMAGE_NAME:latest .
            displayName: 'Build Docker Image'

  - stage: ListDockerImages
    displayName: 'List Docker Images'
    jobs:
      - job: ListImages
        displayName: 'List Docker Images'
        steps:
          - script: |
              docker images
            displayName: 'List Docker Images'

  - stage: TagDockerImage
    displayName: 'Tag Docker Image'
    jobs:
      - job: TagImage
        displayName: 'Tag Docker Image'
        steps:
          - script: |
              docker tag $ACR_NAME/$DOCKER_IMAGE_NAME:latest $ACR_LOGIN_SERVER/$DOCKER_IMAGE_NAME:latest
            displayName: 'Tag Docker Image'

  - stage: PushDockerImage
    displayName: 'Push Docker Image to ACR'
    jobs:
      - job: PushImage
        displayName: 'Push Docker Image to ACR'
        steps:
          - script: |
              docker push $ACR_LOGIN_SERVER/$DOCKER_IMAGE_NAME:latest
            displayName: 'Push Docker Image'

  - stage: PullImageToWebApp
    displayName: 'Pull Docker Image to Azure Web App'
    jobs:
      - job: ConfigureWebApp
        displayName: 'Configure Azure Web App with Docker Image'
        steps:
          - script: |
              az webapp config container set --name $AZURE_WEB_APP_NAME \
              --resource-group $AZURE_RESOURCE_GROUP \
              --docker-custom-image-name $ACR_LOGIN_SERVER/$DOCKER_IMAGE_NAME:latest \
              --docker-registry-server-url https://$ACR_LOGIN_SERVER \
              --docker-registry-server-user $ACR_USERNAME \
              --docker-registry-server-password $ACR_PASSWORD
            displayName: 'Configure Azure Web App'
